import express from "express";
import multer from "multer";
import { spawn } from "child_process";
import http from "http";
import { Server } from "socket.io";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const server = http.createServer(app);
const io = new Server(server);

app.use(express.static("public"));
const upload = multer({ dest: "uploads/" });

let pythonProcess = null;

// === File Upload ===
app.post("/upload", upload.single("file"), (req, res) => {
  if (!req.file) return res.status(400).send("No file uploaded!");
  const newPath = path.join(__dirname, "uploads", req.file.originalname);
  fs.renameSync(req.file.path, newPath);
  res.send("File uploaded successfully!");
});

// === Run Python File ===
app.post("/run", (req, res) => {
  if (pythonProcess) return res.send("Bot already running!");
  const files = fs.readdirSync(path.join(__dirname, "uploads"));
  if (files.length === 0) return res.send("No Python file uploaded!");
  const filePath = path.join(__dirname, "uploads", files[files.length - 1]);

  pythonProcess = spawn("python3", [filePath]);

  pythonProcess.stdout.on("data", (data) => {
    io.emit("log", data.toString());
  });

  pythonProcess.stderr.on("data", (data) => {
    io.emit("log", "⚠️ " + data.toString());
  });

  pythonProcess.on("close", (code) => {
    io.emit("log", `Bot stopped (exit code ${code})`);
    pythonProcess = null;
  });

  res.send("Bot started!");
});

// === Stop Bot ===
app.post("/stop", (req, res) => {
  if (!pythonProcess) return res.send("No bot running!");
  pythonProcess.kill();
  pythonProcess = null;
  res.send("Bot stopped!");
});

server.listen(10000, () => console.log("✅ Server running on port 10000"));
